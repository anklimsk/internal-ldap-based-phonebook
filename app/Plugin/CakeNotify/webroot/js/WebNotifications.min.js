(function(a,b){if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){module.exports=b()}else{a.WebNotifications=b()}}})(this,function(){var e={};var b=null;var j=null;var a=30000;var d="/cake_notify/notifications/message";function g(){if(_storageObj){return true}return false}function h(){var n=Date.now();var o=l();var m=i();if(o===0){return true}if((n-o)<=(m*2)){return false}return true}function f(){var n="TimeLastUpdate";if(!g()){return}var m=Date.now();_storageObj.set(n,m)}function l(){var n="TimeLastUpdate";if(!g()||!_storageObj.isSet(n)){return 0}var m=_storageObj.get(n);return m}function k(m){var n="SSEretry";if(!g()){return}_storageObj.set(n,m);return}function i(){var n="SSEretry";if(!g()||!_storageObj.isSet(n)){return a}var m=_storageObj.get(n);return m}function c(n){var m=$.parseJSON(n.data);if(m.retry&&(m.retry>5000)){k(m.retry)}f();if(!m.result||(m.messages.length===0)){return}$.each(m.messages,function(p,o){e.showNotification(o)})}e.initStorage=function(){if(typeof Storages==="undefined"){return false}_storageObj=Storages.initNamespaceStorage("web_notifications").localStorage;return true};e.initSSE=function(){if(!jQuery.SSE){return false}var m=d+".sse";j=$.SSE(m,{options:{forceAjax:false},events:{webNotification:c},onError:function(n){f();if(e.initSSE()){e.startSSE()}}});return true};e.startSSE=function(){if(h()||!g()){j.start()}else{var m=i();setTimeout(e.startSSE,(m*3))}};e.showNotification=function(o){if(!("Notification" in window)){return false}var p=null;var m={title:"",body:"",data:{}};o=$.extend({},m,o);var q=o.title;delete o.title;var n=o;if(!q||!n.body){return false}if(Notification.permission==="granted"){p=new Notification(q,n)}else{if(Notification.permission!=="denied"){Notification.requestPermission(function(r){if(r==="granted"){p=new Notification(q,n)}})}}if(!p){return false}if(n.data&&n.data.url){p.onclick=function(r){r.preventDefault();window.open(n.data.url,"_blank")}}return p};return e});$(function(){if(!("Notification" in window)){return}WebNotifications.initStorage();if(WebNotifications.initSSE()){WebNotifications.startSSE()}});